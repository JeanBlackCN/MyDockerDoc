## k8s部署进度说明文档 北爱


### 1.进度说明
							
* 开发平台管理员登录地址

		https://service.wonderscloud.com/huidaoManager/open/?channel=platform#/
	
	
* 开发平台账号

		服务商账号： serviceprovider@wondersgroup.com
	         密码： Wonders@369

	    开发商账号： healthmanager@wondersgroup.com
	         密码： Wonders@318
	    开发商账号： octopus@octopus.com
	         密码： Wonders@110
	         
		管理员登录：
	    管理员登录：http://service.wonderscloud.com/huidaoManager/login/channel/

	    管理员账号：mobileserviceplatform@wondersgroup.com
	         密码： Wonders@114
	         
* clientgateway入口地址

		https://service.wonderscloud.com/clientgateway/


* nginx

		地址 172.17.14.12		
		端口 80
		映射 /clientgateway/  
				http://172.18.14.11:32771/huidaoManager/
				http://172.18.14.12:32771/huidaoManager/
				http://172.18.14.13:32771/huidaoManager/
		映射 /huidaoManager/
				http://172.18.14.11:81/
				http://172.18.14.12:81/
				http://172.18.14.13:81/
		映射 /lightapp/
				http://172.18.14.11:6072/lightapp/
				http://172.18.14.12:6072/lightapp/
				http://172.18.14.13:6072/lightapp/
				
			
				
* mongo 

		地址 172.18.11.50
		端口 27000
		用户名 octo
		密码 octo
		DB octo

* redis 
		
		地址 172.18.10.21
		端口 8001
		
* mysql 

		huidaomanage
		
		地址 172.19.17.31
		端口 8800
		数据库名称 mobservicedb
		用户名 mobservice
		密码 mobservice2017
		
		轻应用
		
		地址 172.19.17.31
		端口 8800
		数据库名称 cspldb
		用户名 mobservice
		密码 mobservice2017

* nsq

		地址 172.18.14.11
		端口 4161,4150,4151,4171
		
* consul

		地址 172.18.14.11，172.18.14.12，172.18.14.13
		端口 8500
		地址 ip+端口/v1/catalog/service/ocauth/ + 镜像名

* 私有镜像库

		地址 172.18.14.11
		端口 5000


### 2.部署细节


	consul
	docker run -d -h node-server-1-1 \
	    -p 172.18.14.11:8300:8300 \
	    -p 172.18.14.11:8301:8301 \
	    -p 172.18.14.11:8301:8301/udp \
	    -p 172.18.14.11:8302:8302 \
	    -p 172.18.14.11:8302:8302/udp \
	    -p 172.18.14.11:8400:8400 \
	    -p 172.18.14.11:8500:8500 \
	    172.18.14.11:5000/base/consul -server -advertise 172.18.14.11 -bootstrap-expect 3


	docker run -d -h node-server-2-1 \
	    -p 172.18.14.12:8300:8300 \
	    -p 172.18.14.12:8301:8301 \
	    -p 172.18.14.12:8301:8301/udp \
	    -p 172.18.14.12:8302:8302 \
	    -p 172.18.14.12:8302:8302/udp \
	    -p 172.18.14.12:8400:8400 \
	    -p 172.18.14.12:8500:8500 \
	    172.18.14.11:5000/base/consul -server -advertise 172.18.14.12 -join 172.18.14.11

	docker run -d -h node-server-3-1 \
	    -p 172.18.14.13:8300:8300 \
	    -p 172.18.14.13:8301:8301 \
	    -p 172.18.14.13:8301:8301/udp \
	    -p 172.18.14.13:8302:8302 \
	    -p 172.18.14.13:8302:8302/udp \
	    -p 172.18.14.13:8400:8400 \
	    -p 172.18.14.13:8500:8500 \
	    172.18.14.11:5000/base/consul -server -advertise 172.18.14.13 -join 172.18.14.11


	nsq
	docker run -d --name lookupd -p 4160:4160 -p 4161:4161 172.18.14.11:5000/base/nsq /nsqlookupd

	docker run -d --name nsqd -p 4150:4150 -p 4151:4151 \
	    172.18.14.11:5000/base/nsq /nsqd \
	    --broadcast-address=172.18.14.11 \
	    --lookupd-tcp-address=172.18.14.11:4160

	docker run -d --name nsqadmin -p 4171:4171 172.18.14.11:5000/base/nsq /nsqadmin  --lookupd-http-address=172.18.14.11:4161


*	镜像启动脚本(12根目录)

		/home/wonders

*	镜像库

		172.18.14.11:5000
		172.18.14.11:/home/wonders/huidao/ 有所有的镜像文件
		
		
*  镜像启动命令——jenkins
	
	* apigateway

				docker run -dP --name=apigateway \
				-p 82:9000 \
			    -e  CONFIG_CONSUL_HOSTS=172.18.14.11:8500,172.18.14.12:8500,172.18.14.13:8500  \
			    -e  CONFIG_OS_CATALOGID_HTMLGATEWAY=htmlgateway  \
			    -e  DB_HOST=172.19.17.31  \
			    -e  DB_NAME=mobservicedb  \
			    -e  DB_PORT=8800  \
			    -e  DB_PW=mobservice2017  \
			    -e  DB_USER=mobservice  \
			    -e  REDIS_HOST=172.18.10.21  \
			    -e  REDIS_PORT=8001  \
			    -e  REDIS_PASSWORD=Smy2017
			    -e  HTML_GATEWAY_URL=""  \
			    -e  NSQ_LOOKUPD_ADD=172.18.14.11:4161  \
			    -e  NSQD_ADD_TCP=172.18.14.11:4150  \
			    -e  NSQD_TOPIC_APIGATEWAY=apigateway_log \
			   172.18.14.11:5000/huidao1.2/apigateway:huidao1.2-beta
			   
	* clientgateway

				docker run -dP --name=clientgateway \
				-p 81:9000 \
				-e CONFIG_CONSUL_HOSTS=172.18.14.11:8500,172.18.14.12:8500,172.18.14.13:8500 \
				-e CONFIG_OS_CATALOGID_HUIDAO_OCAUTH=ocauth-3000 \
				-e CONFIG_OS_CATALOGID_HUIDAO_OCAUTHRPC=ocauth-3001 \
				-e CONFIG_OS_CATALOGID_APIGATEWAY=apigateway \
				172.18.14.11:5000/huidao1.2/clientgateway:huidao1.2-beta
				
	* htmlgateway

				docker run -dP --name=htmlgateway \
				-e  MONGO_HOST=172.18.11.50 \
			 	-e  MONGO_PORT=27000 \
				-e  MONGO_USER=octo \
				-e  MONGO_PW=octo \
			 	-e  MONGO_MECHANISM=SCRAM-SHA-1 \
			 	-e  MONGO_SOURCE=octo \
			 	-e  MONGO_COLLECTION=log
			 	-e  REDIS_HOST=172.18.10.21 \
				-e  REDIS_PORT=8001 \
				-e  REDIS_PASSWORD=Smy2017
				172.18.14.11:5000/huidao1.2/htmlgateway:huidao1.2-beta
			    
	* ocauth

				docker run -dP --name=ocauth \
			    -e  DB_HOST=172.19.17.31  \
			    -e  DB_NAME=mobservicedb  \
			    -e  DB_PORT=8800  \
			    -e  DB_PW=mobservice2017  \
			    -e  DB_USER=mobservice \
			    -e  REDIS_HOST=172.18.10.21  \
			    -e  REDIS_PORT=8001  \
			    -e  REDIS_PASSWORD=Smy2017
				-e  MONGO_HOST=172.18.11.50 \
				-e  MONGO_PORT=27000 \
				-e  MONGO_USER=octo \
				-e  MONGO_PW=octo \
				-e  MONGO_MECHANISM=SCRAM-SHA-1 \
				-e  MONGO_SOURCE=octo \
				-e  CONFIG_CONSUL_HOSTS=172.18.14.11:8500
				-e	CONFIG_OS_CATALOGID_HUIDAO_OCAUTH=ocauth-3000 
				-e	FILE_UPLOAD_HOST=172.18.14.12:8001
			    172.18.14.11:5000/huidao1.2/ocauth:huidao1.2-beta
			    
			    
	* statisticalanalysis
			    			    
				docker run -d --name statisticalanalysis 172.18.14.11:5000/huidao1.2/statisticalanalysis:huidao1.2-beta
				    
				    
	* huidaoserver

				 docker run -d -p 10056:8080 --restart=always --name huidao_server 
				   -e  DB_URL=jdbc:mysql://172.19.17.31:8800/mobservicedb
				   -e  DB_USERNAME=mobservice
			      -e  DB_PASSWORD=mobservice2017
				   172.18.14.11:5000/huidao1.2/huidao_server:huidao1.2-beta
				   
	*  huidaofileserver

				docker run -d -p 32777:2580 -p 32776:8001 --restart=always  -v /lib/data/data:/Users/chavn/Dev/Lab/f2eserver_sc/f2e-server/ -v /lib/data/bak:/Users/chavn/Dev/Lab/f2eserver_sc_out --name huidao_fileserver 172.18.14.11:5000/huidao1.2/huidao_fileserver:huidao1.2-beta
				
				
	*  huidao_manage	   

			docker run -d -p 32771:3000 --restart=always --name huidao_manage 
			-e OCAUTHHTTPIP=172.18.14.11
			-e OCAUTHHTTPPORT=8500
			-e OCAUTHHTTPPATH=/v1/catalog/service/ocauth-3000
			-e OCAUTHRPCIP=172.18.14.11
			-e OCAUTHRPCPORT=8500
			-e OCAUTHRPCPATH=/v1/catalog/service/ocauth-3001
			-e SERVERIP=172.18.14.11
			-e SERVERPORT=8500
			-e SERVERPATH=/v1/catalog/service/huidao_server
			-e NSQL_IP=172.18.14.11
			-e NSQL_PORT=4150
			-e NSQL_MESSAGE_PORT=4161	
			-e CLIENTGATEWAY_METHOD=https  
  			-e HUIDAO_MANAGE_METHOD=https
  			-e LIGHT_APP_METHOD=https
			

			-e MONGODB_SESSION_IP=172.18.11.50
			-e MONGODB_SESSION_PORT=27000
			-e MONGODB_SESSION_COLLECTION=/octo/huidao
			-e MONGODB_SESSION_NAME=octo
			-e MONGODB_SESSION_PSW=octo
			
			-e MONGODB_STATISTICS_IP=172.18.11.50
			-e MONGODB_STATISTICS_PORT=27000
			-e MONGODB_STATISTICS_COLLECTION=/octo/octopus
			
			-e FILE_SERVER_IP=172.18.14.12
			-e FILE_SERVER_PORT=8001
			
			-e HUIDAO_MANAGE_ADDRESS=service.wonderscloud.com
			-e LIGHT_APP_ADDRESS=service.wonderscloud.com
			
			-e CLIENTGATEWAY_ADDRESS=service.wonderscloud.com
			-e CLIENTGATEWAY_PATH=clientgateway/huidaoocauth
			
			172.18.14.11:5000/huidao1.2/huidao_manage:huidao1.2-beta
			
    *  lightapp
  
			  docker run -d -p 6072:6072  --name lightapp --restart=always 
			  -e NODE_PORT=6072
			  -e DB_HOST=172.19.17.31
			  -e DB_PORT=8800
			  -e DB_DATABASE=cspldb
			  -e DB_USER=mobservice
			  -e DB_PW=mobservice2017
			  -e UPLOAD_REMOTE_URL=http://172.18.14.12:8001/upload
			  -e CONSUL_HOST=172.18.14.11
			  -e CONSUL_PORT=8500
			  -e CONSUL_CONST=/v1/catalog/service/
			  -e CONSUL_AUTH_DOCKER=ocauth-3000
			  -e AUTH_GETTOKEN=/authorizing/tokenbycode
			  -e CONSUL_HD_DOCKER=huidao_server
			  -e HD_GETUSER=/huidao_server/channel/user/
			  -e HD_GETAPP=/huidao_server/app/
			  -e HD_CHECKSTATUS=/huidao_server/appServiceRS/checkCreateRs
			  -e CONSUL_CLIENTGATEWAY_DOCKER=clientgateway
			  -e CLIENTGATEWAY_GETTOKEN=/huidaoocauth/app/token
			  -e HD_SITE_CROSS=https://service.wonderscloud.com/huidaoManager/cross
			  -e SELF_SITE=https://service.wonderscloud.com/lightapp
			  -e SELF_IP_PORT=https://service.wonderscloud.com
			  -e MONGODB_SESSION_HOST=172.18.11.50
			  -e MONGODB_SESSION_PORT=27000
            -e MONGODB_SESSION_DB=octo
            -e MONGODB_SESSION_COLLECTION=lightapp
            -e MONGODB_SESSION_NAME=octo
            -e MONGODB_SESSION_PSW=octo
			   172.18.14.11:5000/huidao1.2/lightapp:huidao1.2-beta
			   
	* ocgatewaycounter		 

				docker run -d --name=ocgatewaycounter -e MONGO_HOST=172.18.11.50 -e MONGO_PORT=27000 -e MONGO_USER=octo -e MONGO_PW=octo -e MONGO_SOURCE=octo -e MONGO_MECHANISM=SCRAM-SHA-1 -e NSQDADD=172.18.14.11:4161 -e NSQ_TOPIC=apigateway_log -e NSQ_CHANNEL=ocgatewaycounter 172.18.14.11:5000/huidao1.2/ocgatewaycounter:huidao1.2-beta