## k8s部署进度说明文档


### 1.进度说明

*	～ 2016_1228 完成情况

	*	1.部署情况
	
			管理平台除:huidao_api_monitor其他单机部署完毕
			轻应用单机部署完毕
			网关单机部署完毕
			
	*	2.开发平台地址
			
			http://10.1.74.36:32771/huidaoManager/open/  
			
			通过这个注册的开发商全部隶属于mobileserviceplatform@wondersgroup.com用户。

	*	3.开发平台管理员登录地址

			http://10.1.74.36:32771/huidaoManager/login/channel/ 

	*	4.开发平台账号
	
			管理员账号:mobileserviceplatform@wondersgroup.com
			密码:Wonders@114    
			只有这个账户有一部分服务，包含鸣哥预留的两个服务。


			开发商账号1:healthmanager@wondersgroup.com
			密码:Wonders@318


    		开发商账号2:octopus@octopus.com
    		密码:Wonders@110
   
   			开发商账号3:zhangyi001@wondersgroup.com
   			密码:Wonders@2017002
   			
   	*	5.轻应用入口地址
   	
   			http://10.1.74.36:6072
   			
   			
   	*	6.网关入口地址
   		
   			http://10.1.74.36:32769
   			
   	*	7.文件服务器入口地址
   		
   			http://10.1.74.35:8001
   			
   	*  8.consul地址路径

   			http://10.1.74.35:8500/v1/catalog/service/  +   镜像名



*	～ 2016_1209 完成情况

		1.汇到1.2管理平台
			整理工程，提取环境变量，打包镜像
				huidao_node_file_server
				huidao_server
				huidao_manage
				huidao_api_monitor
				
				
		2.汇到1.2网关
			整理工程，提取环境变量，打包镜像
				ocauth: 10.1.65.227:5000/huidao1.2/ocauth:huidao1.2-beta 
				apigateway: 10.1.65.227:5000/huidao1.2/apigateway:huidao1.2-beta 
				htmlgateway: 10.1.65.227:5000/huidao1.2/htmlgateway:huidao1.2-beta 
				clientgateway: 10.1.65.227:5000/huidao1.2/clientgateway:huidao1.2-beta 
				statisticalanalysis: 10.1.65.227:5000/huidao1.2/statisticalanalysis:huidao1.2-beta 
				
		3.环境支撑
			集群部署docker、consul、nsq等组件
				10.1.74.35
				10.1.74.36
				10.1.74.37
				10.1.74.38
			
		//3.k8环境
		//	集群部署k8，以及docker、etcd、flannel等组件
		//		10.1.74.32
		//		10.1.74.33
		//		10.1.65.67
				

### 2.部署细节
### 2.1.Docker部署consul集群及组件
#### 2.1.1 consul集群
* 机器资源及配置：
``10.1.74.35 node-server-1-1``
``10.1.74.36 node-server-2-1``
``10.1.74.37 node-server-3-1``
启动命令如下：
* ``10.1.74.35``启动node-server-1-1
```
docker run -d --name node-server-1-1 -h node-server-1-1 \
    -p 8300:8300 -p 8301:8301 \
    -p 8301:8301/udp \
    -p 8302:8302 \
    -p 8302:8302/udp \
    -p 8400:8400 \
    -p 8500:8500 \
    -p 53:53 \
    -p 53:53/udp \
    10.1.74.34:5000/base/consul -server -advertise 10.1.74.35 -bootstrap-expect 3
    ```
    * ``10.1.74.36``启动node-server-2-1
    ```
    docker run -d --name node-server-2-1 -h node-server-2-1 \
    -p 8300:8300 \
    -p 8301:8301 \
    -p 8301:8301/udp \
    -p 8302:8302 \
    -p 8302:8302/udp \
    -p 8400:8400 \
    -p 8500:8500 \
    -p 53:53 \
    -p 53:53/udp \
    10.1.74.34:5000/base/consul -server -advertise 10.1.74.36 -join 10.1.74.35
```
* ``10.1.74.37``启动node-server-3-1
```
docker run -d --name node-server-3-1 -h node-server-3-1 \
    -p 8300:8300 \
    -p 8301:8301 \
    -p 8301:8301/udp \
    -p 8302:8302 \
    -p 8302:8302/udp \
    -p 8400:8400 \
    -p 8500:8500 \
    -p 53:53 \
    -p 53:53/udp \
    10.1.74.34:5000/base/consul -server -advertise 10.1.74.37 -join 10.1.74.35
```
consul集群部署完毕。
#### 2.1.2 Docker部署服务发现插件registrator
* ``10.1.74.35``部署命令
```
docker run -d --name=registrator \
    --volume=/var/run/docker.sock:/tmp/docker.sock \
    -h 10.1.74.35 \
    10.1.74.34:5000/base/registrator consul://10.1.74.35:8500
```
其中``-h``后为本机内网IP, ``consul://``后为consul集群节点ip:host,一般使用本机consul集群节点地址，其余两台主机部署命令同上。

### 2.2 Docker部署NSQ分布式消息处理平台
NSQ整体包括三个组件，分别为``nsqlookupd``，``nsqd``，``nsqadmin``，此次部署NSQ组件于``10.1.74.35``机器上，分散部署也可以，其中nsqadmin为dashboard，非必须组件。
``nsqlookupd``:
```
docker run --name lookupd \
    -dp 4160:4160 \
    -p 4161:4161 \
    10.1.74.34:5000/base/nsq /nsqlookupd
```
``nsqd``
```
docker run --name nsqd -dp 4150:4150 -p 4151:4151 \
    10.1.74.34:5000/base/nsq /nsqd \
   --broadcast-address=10.1.74.35  \
   --lookupd-tcp-address=10.1.74.35:4160

```
``nsqadmin``
```
docker run -d --name nsqadmin -p 4171:4171 10.1.74.34:5000/base/nsq /nsqadmin  --lookupd-http-address=10.1.74.35:4161
```

### 2.3 部署私有镜像库Registry
将私有镜像库部署在``10.1.74.37``上，查找镜像访问[这里][1]
```
docker run -dp 5000:5000 \
            --restart=always \
            -v /opt/registry:/var/lib/registry \
            --name huidao_registry registry
```
registry v2 http api如下:
```
method 	path 	Entity 	Description
GET 	/v2/ 	Base 	Check that the endpoint implements Docker Registry API V2.
GET 	/v2/<name>/tags/list 	Tags 	Fetch the tags under the repository identified by name.
GET 	/v2/<name>/manifests/<reference> 	Manifest 	Fetch the manifest identified by nameand referencewhere referencecan be a tag or digest. A HEADrequest can also be issued to this endpoint to obtain resource information without receiving all data.
PUT 	/v2/<name>/manifests/<reference> 	Manifest 	Put the manifest identified by nameand referencewhere referencecan be a tag or digest.
DELETE 	/v2/<name>/manifests/<reference> 	Manifest 	Delete the manifest identified by nameand reference. Note that a manifest can only be deleted by digest.
GET 	/v2/<name>/blobs/<digest> 	Blob 	Retrieve the blob from the registry identified bydigest. A HEADrequest can also be issued to this endpoint to obtain resource information without receiving all data.
DELETE 	/v2/<name>/blobs/<digest> 	Blob 	Delete the blob identified by nameand digest
POST 	/v2/<name>/blobs/uploads/ 	Initiate Blob Upload 	Initiate a resumable blob upload. If successful, an upload location will be provided to complete the upload. Optionally, if thedigest parameter is present, the request body will be used to complete the upload in a single request.
GET 	/v2/<name>/blobs/uploads/<uuid> 	Blob Upload 	Retrieve status of upload identified byuuid. The primary purpose of this endpoint is to resolve the current status of a resumable upload.
PATCH 	/v2/<name>/blobs/uploads/<uuid> 	Blob Upload 	Upload a chunk of data for the specified upload.
PUT 	/v2/<name>/blobs/uploads/<uuid> 	Blob Upload 	Complete the upload specified by uuid, optionally appending the body as the final chunk.
DELETE 	/v2/<name>/blobs/uploads/<uuid> 	Blob Upload 	Cancel outstanding upload processes, releasing associated resources. If this is not called, the unfinished uploads will eventually timeout.
GET 	/v2/_catalog 	Catalog 	Retrieve a sorted, json list of repositories available in the registry.
```
### 2.4 部署数据库容器
#### 2.4.1 MySQL
```
 docker run -dp 50003:3306 --name=huidao_mysql \
 -e MYSQL_ROOT_PASSWORD=root \ 
 -v /root/mysql_data:/var/lib/mysql \
 --restart=always  10.1.65.227:5000/base/mysql5.6.23
```
#### 2.4.2 MongoDB
```
docker run -dp 50000:27017 \
--name huidao_mongo \
--restart=always \
-v /root/mongo_data:/data/db  10.1.65.227:5000/library/mongo
```
#### 2.4.3 Redis
```
docker run -dp 50001:6379 --name=huidao_redis --restart=always 10.1.65.227:5000/base/redis
```
### 2.5 Docker部署命令
#### 2.5.1 ClientGateway

```
docker run -dP --name=clientgateway \
	-e CONFIG_CONSUL_HOSTS=10.1.74.35:8500,10.1.74.36:8500,10.1.74.37:8500 \
	-e CONFIG_OS_CATALOGID_HUIDAO_OCAUTH=ocauth-3000 \
	-e CONFIG_OS_CATALOGID_HUIDAO_OCAUTHRPC=ocauth-3001 \
	-e CONFIG_OS_CATALOGID_APIGATEWAY=apigateway \
	10.1.74.37:5000/huidao1.2/clientgateway:huidao1.2-beta
```

#### 2.5.2 APIGateway

```
docker run -dP --name=apigateway \
	-e CONFIG_CONSUL_HOSTS=10.1.74.35:8500,10.1.74.36:8500,10.1.74.37:8500  \
	-e  CONFIG_OS_CATALOGID_HTMLGATEWAY=htmlgateway  \
	-e  DB_HOST=10.1.74.35  \
	-e  DB_NAME=huidao_1_2  \
	-e  DB_PORT=50003  \
	-e  DB_PW=root  \
	-e  DB_USER=root  \
	-e  MONGO_HOST=10.1.74.35  \
	-e  MONGO_PORT=50000  \
	-e  REDIS_HOST=10.1.74.35  \
	-e  REDIS_PORT=50001  \
	-e  HTML_GATEWAY_URL=""  \
	-e  NSQ_LOOKUPD_ADD=10.1.74.35:4161  \
	-e  NSQD_ADD_TCP=10.1.74.35:4150  \
	-e  NSQD_TOPIC_APIGATEWAY=apigateway_log \
	10.1.74.37:5000/huidao1.2/apigateway:huidao1.2-beta
```

#### 2.5.3 HTMLGateway

```
docker run -dP --name=htmlgateway \
	-e  MONGO_HOST=10.1.74.35 \
 	-e  MONGO_PORT=50000 \
	-e  MONGO_USER="" \
	-e  MONGO_PW="" \
 	-e  MONGO_MECHANISM="" \
 	-e  MONGO_SOURCE=octopus \
 	-e  REDIS_HOST=10.1.74.35 \
	-e  REDIS_PORT=50001 \
	10.1.74.37:5000/huidao1.2/htmlgateway:huidao1.2-beta
```

#### 2.5.4 OCAuth

```
docker run -dP --name=ocauth \
 	-e DB_HOST=10.1.74.35 \
 	-e DB_NAME=huidao_1_2 \
 	-e DB_PORT=50003 \
 	-e DB_PW=root \
 	-e DB_USER=root \
 	-e REDIS_HOST=10.1.74.35 \
 	-e REDIS_PORT=50001 \
 	-e MONGO_HOST=10.1.74.35 \
 	-e MONGO_PORT=50000 \
 	-e MONGO_DB=db \
	-e MONGO_COLLECTION=log \
	-e FILE_UPLOAD_HOST=10.1.74.35:8001 \
	10.1.74.37:5000/huidao1.2/ocauth:huidao1.2-beta
```

#### 2.5.5 OCGatewayCounter

```
docker run -d --name=ocgatewaycounter \
	-e MONGO_HOST=10.1.74.35 \
	-e MONGO_PORT=50000 \
	-e NSQDADD=10.1.74.35:4161 \
	-e NSQ_TOPIC=apigateway_log \
	-e NSQ_CHANNEL=ocgatewaycounter \
	10.1.74.37:5000/huidao1.2/ocgatewaycounter:huidao1.2-beta
```

#### 2.5.6 StatisticalAnalysis

```
docker run -d --name statisticalanalysis \
	-e MONGO_HOST=10.1.74.35 \
	-e MONGO_PORT=50000 \
 	-e MONGO_SOURCE=octopus \
 	-e MONGO_COL=oc \
 	-e DB_HOST=10.1.74.35 \
 	-e DB_NAME=huidao_1_2 \
 	-e DB_PORT=50003 \
 	-e DB_PW=root \
 	-e DB_USER=root \
 	-e HOUR=23 \
	-e MIN=58 \
	10.1.74.37:5000/huidao1.2/statisticalanalysis:huidao1.2-beta
```
  [1]: http://10.1.74.37:5000/v2/_catalog/ 
  
  
  
#### 2.5.7 lightapp
  
	  docker run -d -P --name lightapp --restart=always 
	  -e NODE_PORT=6072
	  -e DB_HOST=10.1.74.35
	  -e DB_PORT=50003
	  -e DB_DATABASE=lightapp_huidao
	  -e DB_USER=root
	  -e DB_PW=root
	  -e UPLOAD_REMOTE_URL=http://10.1.74.35:8001/upload
	  -e CONSUL_HOST=10.1.74.35
	  -e CONSUL_PORT=8500
	  -e CONSUL_CONST=/v1/catalog/service/
	  -e CONSUL_AUTH_DOCKER=ocauth-3000
	  -e AUTH_GETTOKEN=/authorizing/tokenbycode
	  -e CONSUL_HD_DOCKER=huidao_server
	  -e HD_GETUSER=/huidao_server/channel/user/
	  -e HD_GETAPP=/huidao_server/app/
	  -e HD_CHECKSTATUS=/huidao_server/appServiceRS/checkCreateRs
	  -e CONSUL_CLIENTGATEWAY_DOCKER=clientgateway
	  -e CLIENTGATEWAY_GETTOKEN=/huidaoocauth/app/token
	  -e HD_SITE_CROSS=http://10.1.64.158:10029/huidaoManger/cross
	   10.1.74.37:5000/huidao1.2/lightapp:huidao1.2-beta
   
#### 2.5.8 huidaoserver  
   
	   docker run -d -p 10056:8080 --restart=always --name huidao_server 
	   -e  DB_URL=jdbc:mysql://10.1.74.35:50003/huidao_1_2
	   -e  DB_USERNAME=root
      -e  DB_PASSWORD=root
	   10.1.74.37:5000/huidao1.2/huidao_server:huidao1.2-beta
	   
#### 2.5.8 huidaofileserver  
   
	   docker run -d -p 2580:2580 -p 8001:8001 --restart=always  -v /lib/data/data:/Users/chavn/Dev/Lab/f2eserver_sc/f2e-server/ -v /lib/data/bak:/Users/chavn/Dev/Lab/f2eserver_sc_out --name huidao_fileserver 10.1.74.37:5000/huidao1.2/huidao_fileserver:huidao1.2-beta
	   
#### 2.5.9 huidao_manage	   

	docker run -d -p 32771:3000 --restart=always --name huidao_manage 
	-e OCAUTHHTTPIP=10.1.74.35
	-e OCAUTHHTTPPORT=8500
	-e OCAUTHHTTPPATH=/v1/catalog/service/ocauth-3000
	-e OCAUTHRPCIP=10.1.74.35
	-e OCAUTHRPCPORT=8500
	-e OCAUTHRPCPATH=/v1/catalog/service/ocauth-3001
	-e SERVERIP=10.1.74.35
	-e SERVERPORT=8500
	-e SERVERPATH=/v1/catalog/service/huidao_server
	-e NSQL_IP=10.1.74.35
	-e NSQL_PORT=4150
	-e NSQL_MESSAGE_PORT=4161	
	
	-e LIGHT_APP_IP=10.1.74.36
	-e LIGHT_APP_PORT=6072
	
	-e MONGODB_SESSION_IP=10.1.74.35
	-e MONGODB_SESSION_PORT=50000
	-e MONGODB_SESSION_COLLECTION=/huidao
	
	-e MONGODB_STATISTICS_IP=10.1.74.35
	-e MONGODB_STATISTICS_PORT=50000
	-e MONGODB_STATISTICS_COLLECTION=/octopus
	
	-e FILE_SERVER_IP=10.1.74.35
	-e FILE_SERVER_PORT=8001
	
	-e HUIDAO_MANAGE_IP=10.1.74.36
	-e HUIDAO_MANAGE_PORT=32771
	
	-e CLIENTGATEWAY_IP=10.1.74.36
	-e CLIENTGATEWAY_PORT=32769
	
	10.1.74.37:5000/huidao1.2/huidao_manage:huidao1.2-beta